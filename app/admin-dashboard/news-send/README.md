âœ… ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“æ§‹æˆæ¦‚è¦
ğŸ¯ ç›®çš„ï¼š
ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰ã«å¯¾ã—ã¦ã€ãã®æ—¥ã®ãƒãƒƒãƒãƒ³ã‚°è¨˜äº‹ã‚’è‡ªå‹•ãƒ»æ‰‹å‹•ã§é¸å®šãƒ»é€ä¿¡ã™ã‚‹ä»•çµ„ã¿ã€ã‚’æä¾›ã™ã‚‹ç®¡ç†è€…å‘ã‘ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€‚

ğŸ—‚ ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥å½¹å‰²æ•´ç†
1. page.jsï¼ˆ/admin-dashboard/news-sendï¼‰
ç®¡ç†UIã‚’æä¾›ï¼š

ã€Œæœ¬æ—¥ã®ãƒãƒƒãƒãƒ³ã‚°ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ â†’ /api/news-send/generate-matches ã‚’å‘¼ã³å‡ºã—

ã€Œãƒãƒƒãƒãƒ³ã‚°å–å¾—ã€ãƒœã‚¿ãƒ³ â†’ /api/news-send/get-today-targets ã‚’å‘¼ã³å‡ºã—

ã€Œæœ¬æ—¥é…ä¿¡ã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ â†’ /api/news-send/send-today ã‚’å‘¼ã³å‡ºã—

çµæœã®è¡¨ç¤ºæ©Ÿèƒ½ã‚ã‚Š

2. generate-matchesï¼ˆãƒãƒƒãƒãƒ³ã‚°ç”ŸæˆAPIï¼‰
æœ¬æ—¥ã®æ—¥ä»˜ã§ clients Ã— jnet_articles_public ã‚’æ¡ä»¶ã§ç…§åˆ

ä¸€è‡´ã—ãŸ article_id[] ã‚’ client_daily_matches ã« upsert

ä¸€ä»¶ã‚‚ãƒãƒƒãƒã—ãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—

3. get-articles-by-idsï¼ˆè¨˜äº‹æƒ…å ±å–å¾—ï¼‰
è¨˜äº‹IDä¸€è¦§ã‚’å—ã‘å–ã‚Šã€è¨˜äº‹è©³ç´°ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»æ©Ÿé–¢åï¼‰ã‚’ä¸€æ‹¬å–å¾—

4. get-today-targetsï¼ˆå¯¾è±¡è€…ã®ä¸€è¦§å–å¾—ï¼‰
client_daily_matches ã‚’ã‚‚ã¨ã«ã€å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è©³ç´°æƒ…å ±ã‚’çµ±åˆ

usersã€clients ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ JOIN çš„ã«çµ„ã¿åˆã‚ã›ã¦æ•´å½¢è¿”å´

5. send-todayï¼ˆå®Ÿéš›ã®é…ä¿¡ï¼‰
å…¨ users ã«å¯¾ã—ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å±æ€§ã¨è¨˜äº‹ã‚’æ¡ä»¶ã«å†ç…§åˆ

é‡è¤‡é€ä¿¡é˜²æ­¢ï¼ˆdelivery_logs ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰

sendMailToUser ã‚’é€šã˜ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡

çµæœã‚’ user + status å½¢å¼ã§è¿”å´

ğŸ§± ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼šclient_daily_matches ãƒ†ãƒ¼ãƒ–ãƒ«
ã‚«ãƒ©ãƒ å	å‹	èª¬æ˜
id	uuid	ä¸»ã‚­ãƒ¼ã€gen_random_uuid()
user_id	uuid	å¯¾è±¡ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
target_date	date	å¯¾è±¡æ—¥ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ CURRENT_DATE
matched_articles	jsonb	ãƒãƒƒãƒã—ãŸè¨˜äº‹IDé…åˆ—ï¼ˆä¾‹: ["id1", "id2"]ï¼‰
calculated_at	timestamptz	ãƒãƒƒãƒè¨ˆç®—æ™‚åˆ»
source	text	"client" or "admin" ãªã©ã€å‘¼ã³å‡ºã—å…ƒè­˜åˆ¥ã«ä½¿ç”¨

ğŸ” å…¨ä½“ãƒ•ãƒ­ãƒ¼ï¼ˆå›³å¼çš„ã«ï¼‰
sql
ã‚³ãƒ”ãƒ¼ã™ã‚‹
ç·¨é›†ã™ã‚‹
[ç®¡ç†è€…UI (page.js)]
       â”‚
       â”œâ”€â–¶ generate-matchesï¼ˆPOSTï¼‰
       â”‚     â””â”€ client_daily_matches ã«å½“æ—¥åˆ†ã‚’ upsert
       â”‚
       â”œâ”€â–¶ get-today-targetsï¼ˆGETï¼‰
       â”‚     â””â”€ client_daily_matches + users + clients ã‚’ JOIN çš„ã«å–å¾—
       â”‚
       â”œâ”€â–¶ get-articles-by-idsï¼ˆPOSTï¼‰
       â”‚     â””â”€ è©²å½“è¨˜äº‹IDã®è©³ç´°ã‚’ä¸€æ‹¬å–å¾—
       â”‚
       â””â”€â–¶ send-todayï¼ˆPOSTï¼‰
             â”œâ”€ users + clients ã§è©²å½“è¨˜äº‹ã‚’æŠ½å‡º
             â”œâ”€ delivery_logs ã§é€ä¿¡å±¥æ­´ã‚’é™¤å¤–
             â””â”€ sendMailToUser ã«ã‚ˆã‚Šé€ä¿¡å‡¦ç†
